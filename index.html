<!DOCTYPE html>
<html>

<head>
	<title>To Do App</title>
	<!-- Meta-->
	<meta charset="UTF-8">
	<meta name="description" content="To Do App in vanilla Javascript">
	<meta name="keywords" content="HTML, CSS, JavaScript">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Links -->
	<link rel="shortcut-icon" type="image/x-icon" href="favicon.ico">

	<link rel="stylesheet" type="text/css" href="style.css">

	<noscript>This page needs JavaScript enabled to work</noscript>


	<script>

		window.onload = function () {

			//Check if tasks in local storage- else load from file, 
			//then display
			if (localStorage["tasks"] === undefined) {
				tolocalStorageJSONtasks();
			}

			displayJSONtasks(fromlocalStorageJSONtasks());
		}


		// Why do i have to write a script here in html doc and it doesnt load the fucntion
		// defined in the src script???
		function deleteTask(id) {

			// delete from localstorage
			tasks = fromlocalStorageJSONtasks(); // array

			// delete tasks[id];
			// delete JSON.parse(tasks
			for (let i = 0; i < tasks.length; i++) {
				if (tasks[i]["id"] == id) {
					delete tasks[i];
					break;
				}
			}
			tasks = tasks.filter(x => x)

			localStorage.setItem("tasks", JSON.stringify(tasks));


			// delete from DOM
			document.getElementById(`task_${id}`).remove();
			return;
		}

		/**
		 * returns a promise object
		 *
		*/
		async function getJSONtasksFromFile() {
			// returns a promise object

			return fetch("/tasks.json")
				.then(response => {

					if (!response.ok) {
						throw new Error("HTTP error " + response.status);
					}

					return response.json();
				})
				//.then(json => taskContainer = json) // not needed ?
				.catch(error => {
					/* Error handling */
					console.log(error)
				});

		}

		/**
		 * @param promise result
		 * This method saves json tasks in local storage
		 * metadata is erased when parsing it 
		 * 
		 * */
		async function tolocalStorageJSONtasks() { // from get from file
			let result = await getJSONtasksFromFile();
			let tasks = result["tasks"];

			localStorage.setItem("tasks", JSON.stringify(tasks))

			/*
			console.log("localStorage: ");
			console.log(localStorage);
			console.log(JSON.parse(localStorage.getItem("tasks")))
			*/
			//console.log(JSON.parse(localStorage.getItem("task_2")))

		}


		/**
		 * This method loads json tasks from local storage
		 * returns: Array with task objects inside
		 * */
		function fromlocalStorageJSONtasks() {
			let tasks = JSON.parse(localStorage.getItem("tasks"));
			return tasks;
		}


		/**
		 * 
		 * */
		async function displayJSONtasks(taskArray) {

			//let taskArray = await fromlocalStorageJSONtasks();
			let divTasks = document.getElementById("new_task_div");
			taskArray.forEach((task) => {
				divTasks.innerHTML += `<div class="task" id=task_${task["id"]}>
			<p >
				<b> ${task["title"]}</b><br> ` +

					(task["end_date"] == "" ?
						`${task["init_date"]}` :
						`${task["init_date"]} - ${task["end_date"]}`) // if end date null, just init date

					+ `<br>
				
				${task["description"]}
			</p>
			<button onclick="deleteTask(${task["id"]})">X</button><button>Edit</button>
		</div > `
			});

			return;
		}


		function sidebar_open() {
			document.getElementById("mySidebar").style.display = "block";
			document.getElementById("myOverlay").style.display = "block";
		}

		function sidebar_close() {
			document.getElementById("mySidebar").style.display = "none";
			document.getElementById("myOverlay").style.display = "none";
		}

	</script>
</head>

<body>

	<!-- Sidebar -->
	<div class="sidebar" style="display:none;z-index:5" id="mySidebar">
		<button class="w3-bar-item w3-button w3-xxlarge" onclick="sidebar_close()">Close &times;</button>

		<a href="newTask.html" class="w3-bar-item w3-button">Add new task</a>

	</div>


	<!-- Page content-->
	<main>

		<button class="w3-button w3-white w3-xxlarge" id="sideBut" onclick="sidebar_open()">
			â˜°
		</button>

		<div class="overlay" onclick="sidebar_close()" id="myOverlay"></div>

		<section>
			<h1>
				To Do App
			</h1>

			<div id="tasks_div" class="app">

				<div id="new_task_div">

				</div>
			</div>
		</section>

	</main>


	<!--- Footer -->
	<footer>

	</footer>
</body>

</html>